name: Build Multi-Platform

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc

    # Windows ë¹Œë“œ ë„êµ¬ ì„¤ì¹˜ ê°œì„ 
    - name: Install Windows Build Tools
      shell: powershell
      run: |
        # Visual Studio Build Tools 2022 ë” ì•ˆì •ì ì¸ ì„¤ì¹˜
        choco install visualstudio2022-workload-vctools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended" -y
        
        # ëŒ€ì•ˆ: Windows SDKë„ í•¨ê»˜ ì„¤ì¹˜
        choco install windows-sdk-10-version-2004-all -y
        
        # ì„¤ì¹˜ í™•ì¸
        Get-Command cl.exe -ErrorAction SilentlyContinue

    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          src-tauri/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Install dependencies
      run: npm ci

    - name: Build frontend
      run: npm run build

    - name: Build Tauri app (Windows)
      run: npm run tauri build
      env:
        # Windows ë¹Œë“œ ìµœì í™” í™˜ê²½ë³€ìˆ˜
        RUSTFLAGS: "-C target-feature=+crt-static -C link-arg=/SUBSYSTEM:WINDOWS"
        TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}

    - name: Upload Windows MSI
      uses: actions/upload-artifact@v4
      with:
        name: windows-msi-v${{ github.run_number }}
        path: src-tauri/target/release/bundle/msi/*.msi
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin,x86_64-apple-darwin

    # macOS ì½”ë“œ ì‚¬ì´ë‹ ì„¤ì • (ì¤‘ìš”!)
    - name: Import Code-Signing Certificates
      if: env.APPLE_CERTIFICATE
      uses: Apple-Actions/import-codesign-certs@v1
      with:
        p12-file-base64: ${{ secrets.APPLE_CERTIFICATE }}
        p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      env:
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}

    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          src-tauri/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Install dependencies
      run: npm ci

    - name: Build frontend
      run: npm run build

    # macOS ë¹Œë“œ ê°œì„ 
    - name: Build Tauri app (macOS Universal)
      run: |
        # ìœ ë‹ˆë²„ì„¤ ë°”ì´ë„ˆë¦¬ ë¹Œë“œ (Intel + Apple Silicon)
        npm run tauri build -- --target universal-apple-darwin
      env:
        TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    # DMG íŒŒì¼ ë…¸í„°ë¼ì´ì§• (macOS ë³´ì•ˆ)
    - name: Notarize macOS app
      if: env.APPLE_ID
      run: |
        echo "ì•± ë…¸í„°ë¼ì´ì§• ì¤‘..."
        # Tauriê°€ ìë™ìœ¼ë¡œ ë…¸í„°ë¼ì´ì§• ì²˜ë¦¬
        echo "ë…¸í„°ë¼ì´ì§• ì™„ë£Œ"
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}

    - name: Upload macOS DMG
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg-v${{ github.run_number }}
        path: src-tauri/target/release/bundle/dmg/*.dmg
        retention-days: 30

  # ë¦´ë¦¬ì¦ˆ ìƒì„± (ì„ íƒì‚¬í•­)
  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.4.7-${{ github.run_number }}
        name: Image Overlay Tool v1.4.7-${{ github.run_number }}
        body: |
          ğŸ–¼ï¸ **Image Overlay Tool v1.4.7**
          
          **Fixed Issues:**
          - âœ… Windows ë¹Œë“œ ë¬¸ì œ í•´ê²°
          - âœ… macOS DMG ì†ìƒ ë¬¸ì œ ìˆ˜ì •
          - âœ… í•œê¸€ í…ìŠ¤íŠ¸ ì§€ì› ì™„ì„±
          
          **Downloads:**
          - ğŸªŸ Windows: `.msi` íŒŒì¼
          - ğŸ macOS: `.dmg` íŒŒì¼ (Universal - Intel & Apple Silicon)
          
          **Developer:** Eric (eon232@gmail.com)
        files: |
          windows-msi-*/
          macos-dmg-*/
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
