name: ðŸš€ Multi-Platform Build & Release

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: false
        type: boolean

env:
  APP_VERSION: "1.4.7"

jobs:
  # Windows ë¹Œë“œ ìž‘ì—…
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc

    - name: ðŸ› ï¸ Install Windows Build Dependencies
      run: |
        # Visual Studio Build Tools (ê°„ë‹¨í•œ ë°©ë²•)
        choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools" -y
        
        # WebView2 ëŸ°íƒ€ìž„ (Tauri í•„ìˆ˜)
        choco install webview2 -y

    - name: ðŸ“¦ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          src-tauri/target
          node_modules
        key: ${{ runner.os }}-deps-${{ hashFiles('**/Cargo.lock', '**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-deps-

    - name: ðŸ“¦ Install NPM Dependencies
      run: npm ci

    - name: ðŸ—ï¸ Build Frontend
      run: npm run build

    - name: ðŸš€ Build Tauri App (Windows)
      run: npm run tauri:build
      env:
        RUSTFLAGS: "-C target-feature=+crt-static"

    - name: ðŸ“Š Build Results
      run: |
        echo "=== Windows Build Results ==="
        if (Test-Path "src-tauri/target/release/bundle/msi") {
          Get-ChildItem "src-tauri/target/release/bundle/msi" | ForEach-Object {
            Write-Host "âœ… MSI: $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
          }
        } else {
          Write-Host "âŒ No MSI files found"
        }

    - name: ðŸ“¤ Upload Windows MSI
      uses: actions/upload-artifact@v4
      with:
        name: windows-msi
        path: src-tauri/target/release/bundle/msi/*.msi
        retention-days: 30

  # macOS ë¹Œë“œ ìž‘ì—…
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin

    - name: ðŸ› ï¸ Install macOS Dependencies
      run: |
        # create-dmg ì„¤ì¹˜ (ë¡œì»¬ì—ì„œ ì„±ê³µí•œ ë°©ë²•)
        brew install create-dmg

    - name: ðŸ“¦ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          src-tauri/target
          node_modules
        key: ${{ runner.os }}-deps-${{ hashFiles('**/Cargo.lock', '**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-deps-

    - name: ðŸ“¦ Install NPM Dependencies
      run: npm ci

    - name: ðŸ—ï¸ Build Frontend
      run: npm run build

    - name: ðŸš€ Build Tauri App (macOS)
      run: npm run tauri:build

    - name: ðŸ”§ Fix DMG with create-dmg (GitHub Actions ìµœì í™”)
      run: |
        echo "ðŸ”§ GitHub Actions í™˜ê²½ì—ì„œ DMG ìƒì„± ì¤‘..."
        
        cd src-tauri/target/release/bundle/macos
        
        # í˜„ìž¬ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ í™•ì¸
        echo "ðŸ“‚ í˜„ìž¬ ìœ„ì¹˜: $(pwd)"
        echo "ðŸ“ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
        ls -la
        
        # ì•± ë²ˆë“¤ ìƒì„¸ í™•ì¸
        if [ -d "Image overlay tool.app" ]; then
          echo "âœ… ì•± ë²ˆë“¤ ë°œê²¬: $(du -sh 'Image overlay tool.app' | awk '{print $1}')"
          echo "ðŸ“± ì•± ë²ˆë“¤ êµ¬ì¡°:"
          find "Image overlay tool.app" -type f | head -5
          
          # ìž„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„± (GitHub Actions í™˜ê²½ ìµœì í™”)
          TEMP_DMG_DIR="/tmp/dmg_build_$$"
          mkdir -p "$TEMP_DMG_DIR"
          
          # ì•± ë³µì‚¬ (ì‹¬ë§í¬ ë¬¸ì œ í•´ê²°)
          echo "ðŸ“‹ ì•± ë²ˆë“¤ ë³µì‚¬ ì¤‘..."
          cp -R "Image overlay tool.app" "$TEMP_DMG_DIR/"
          
          # Applications ë§í¬ ìƒì„±
          ln -s /Applications "$TEMP_DMG_DIR/Applications"
          
          echo "ðŸ“ ìž„ì‹œ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la "$TEMP_DMG_DIR/"
          
          # ê°„ë‹¨í•œ create-dmg ëª…ë ¹ (GitHub Actions ì•ˆì •í™”)
          echo "ðŸ—ï¸ DMG ìƒì„± ì¤‘..."
          create-dmg \
            --volname "Image overlay tool" \
            --no-internet-enable \
            "../dmg/Image_overlay_tool_v${{ env.APP_VERSION }}_fixed.dmg" \
            "$TEMP_DMG_DIR"
          
          # ìž„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
          rm -rf "$TEMP_DMG_DIR"
          
          echo "âœ… create-dmgë¡œ DMG ìƒì„± ì™„ë£Œ"
        else
          echo "âŒ ì•± ë²ˆë“¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          echo "ðŸ“‚ í˜„ìž¬ ë””ë ‰í† ë¦¬ ì „ì²´ ë‚´ìš©:"
          find . -name "*.app" -type d
          exit 1
        fi

    - name: ðŸ“Š Build Results
      run: |
        echo "=== macOS Build Results ==="
        
        # ì•± ë²ˆë“¤ ì •ë³´
        if [ -d "src-tauri/target/release/bundle/macos/Image overlay tool.app" ]; then
          APP_SIZE=$(du -sh "src-tauri/target/release/bundle/macos/Image overlay tool.app" | awk '{print $1}')
          echo "âœ… App Bundle: Image overlay tool.app ($APP_SIZE)"
        fi
        
        # DMG íŒŒì¼ë“¤ ì •ë³´
        if [ -d "src-tauri/target/release/bundle/dmg" ]; then
          echo "ðŸ“¦ DMG Files:"
          ls -lah src-tauri/target/release/bundle/dmg/*.dmg | while read line; do
            SIZE=$(echo $line | awk '{print $5}')
            NAME=$(basename "$(echo $line | awk '{print $9}')")
            echo "   ðŸ“€ $NAME ($SIZE)"
          done
        fi

    - name: ðŸ§ª Verify Fixed DMG (ê°œì„ ëœ ê²€ì¦)
      continue-on-error: true  # ê²€ì¦ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
      run: |
        echo "ðŸ§ª ìƒì„±ëœ DMG ê²€ì¦ ì¤‘..."
        
        DMG_PATH="src-tauri/target/release/bundle/dmg/Image_overlay_tool_v${{ env.APP_VERSION }}_fixed.dmg"
        
        if [ -f "$DMG_PATH" ]; then
          echo "âœ… ê³ ì •ëœ DMG ë°œê²¬: $(ls -lah "$DMG_PATH" | awk '{print $5}')"
          
          # DMG ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸ (GitHub Actions í™˜ê²½ ìµœì í™”)
          echo "ðŸ“‚ DMG ë§ˆìš´íŠ¸ ì‹œë„ ì¤‘..."
          
          # ì´ì „ ë§ˆìš´íŠ¸ ì •ë¦¬
          hdiutil detach "/Volumes/Image overlay tool" 2>/dev/null || true
          hdiutil detach "/Volumes/Image" 2>/dev/null || true
          
          # DMG ë§ˆìš´íŠ¸
          MOUNT_OUTPUT=$(hdiutil attach "$DMG_PATH" 2>&1)
          echo "ë§ˆìš´íŠ¸ ì¶œë ¥: $MOUNT_OUTPUT"
          
          # ë§ˆìš´íŠ¸ í¬ì¸íŠ¸ ì°¾ê¸° (ì—¬ëŸ¬ ë°©ë²• ì‹œë„)
          MOUNT_POINT=$(echo "$MOUNT_OUTPUT" | grep "/Volumes" | awk '{print $3}' | head -1)
          
          if [ -z "$MOUNT_POINT" ]; then
            # ëŒ€ì•ˆ ë°©ë²•ìœ¼ë¡œ ë§ˆìš´íŠ¸ í¬ì¸íŠ¸ ì°¾ê¸°
            MOUNT_POINT=$(ls /Volumes/ | grep -E "(Image|overlay)" | head -1)
            if [ -n "$MOUNT_POINT" ]; then
              MOUNT_POINT="/Volumes/$MOUNT_POINT"
            fi
          fi
          
          if [ -n "$MOUNT_POINT" ] && [ -d "$MOUNT_POINT" ]; then
            echo "âœ… DMG ë§ˆìš´íŠ¸ ì„±ê³µ: $MOUNT_POINT"
            
            echo "ðŸ“ DMG ë‚´ìš©:"
            ls -la "$MOUNT_POINT/" || echo "ë‚´ìš© ì½ê¸° ì‹¤íŒ¨"
            
            # ì•± ë²ˆë“¤ í™•ì¸ (ì—¬ëŸ¬ ì´ë¦„ìœ¼ë¡œ ì‹œë„)
            APP_FOUND=false
            for app_name in "Image overlay tool.app" "*.app"; do
              if [ -d "$MOUNT_POINT/$app_name" ] || ls "$MOUNT_POINT/"$app_name 2>/dev/null; then
                echo "âœ… ì•± ë²ˆë“¤ ë°œê²¬: $app_name"
                APP_FOUND=true
                break
              fi
            done
            
            if [ "$APP_FOUND" = false ]; then
              echo "âš ï¸ ì•± ë²ˆë“¤ì„ ì°¾ì„ ìˆ˜ ì—†ì§€ë§Œ DMGëŠ” ìƒì„±ë¨"
              echo "ðŸ“ ì°¸ê³ : ì¼ë¶€ í™˜ê²½ì—ì„œëŠ” ì •ìƒì´ì§€ë§Œ ê²€ì¦ì—ì„œ ê°ì§€ë˜ì§€ ì•Šì„ ìˆ˜ ìžˆìŒ"
            fi
            
            # ì–¸ë§ˆìš´íŠ¸
            hdiutil detach "$MOUNT_POINT" 2>/dev/null || true
          else
            echo "âš ï¸ DMG ë§ˆìš´íŠ¸ì— ë¬¸ì œê°€ ìžˆì§€ë§Œ íŒŒì¼ì€ ìƒì„±ë¨"
            echo "ðŸ“ GitHub Actions í™˜ê²½ ì œì•½ìœ¼ë¡œ ì¸í•œ ê²ƒì¼ ìˆ˜ ìžˆìŒ"
          fi
        else
          echo "âŒ ê³ ì •ëœ DMGë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          echo "ðŸ“‚ DMG ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la src-tauri/target/release/bundle/dmg/ || echo "DMG ë””ë ‰í† ë¦¬ ì—†ìŒ"
        fi

    - name: ðŸ“¤ Upload macOS DMG
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: src-tauri/target/release/bundle/dmg/*.dmg
        retention-days: 30

  # ë¹Œë“œ ìš”ì•½ ë° ë¦´ë¦¬ì¦ˆ ìƒì„±
  finalize:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: ðŸ“Š Build Summary
      run: |
        echo "# ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Generated Files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Windows íŒŒì¼ë“¤
        if [ -d "artifacts/windows-msi" ]; then
          echo "### ðŸªŸ Windows" >> $GITHUB_STEP_SUMMARY
          ls -lah artifacts/windows-msi/ | grep -E "\.msi$" | while read line; do
            SIZE=$(echo $line | awk '{print $5}')
            NAME=$(echo $line | awk '{print $9}')
            echo "- âœ… $NAME ($SIZE)" >> $GITHUB_STEP_SUMMARY
          done
        else
          echo "- âŒ Windows build failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # macOS íŒŒì¼ë“¤
        if [ -d "artifacts/macos-dmg" ]; then
          echo "### ðŸŽ macOS" >> $GITHUB_STEP_SUMMARY
          ls -lah artifacts/macos-dmg/ | grep -E "\.dmg$" | while read line; do
            SIZE=$(echo $line | awk '{print $5}')
            NAME=$(echo $line | awk '{print $9}')
            echo "- âœ… $NAME ($SIZE)" >> $GITHUB_STEP_SUMMARY
          done
        else
          echo "- âŒ macOS build failed" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸŽ‰ Create GitHub Release
      if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || inputs.create_release)
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.APP_VERSION }}-build${{ github.run_number }}
        name: "ðŸ–¼ï¸ Image Overlay Tool v${{ env.APP_VERSION }} (Build ${{ github.run_number }})"
        body: |
          # ðŸ–¼ï¸ Image Overlay Tool v${{ env.APP_VERSION }}
          
          **ê°œë°œìž:** Eric (eon232@gmail.com)  
          **ë¹Œë“œ ë²ˆí˜¸:** ${{ github.run_number }}  
          **ì»¤ë°‹:** ${{ github.sha }}
          
          ## âœ¨ ì£¼ìš” ê¸°ëŠ¥
          - ðŸ–¼ï¸ ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ ë„êµ¬
          - ðŸ‡°ðŸ‡· ì™„ë²½í•œ í•œê¸€ ì§€ì›
          - ðŸŽ¨ ì‚¬ìš©í•˜ê¸° ì‰¬ìš´ ì¸í„°íŽ˜ì´ìŠ¤
          
          ## ðŸ“¥ ë‹¤ìš´ë¡œë“œ
          
          ### ðŸªŸ Windows
          - `.msi` íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì„¤ì¹˜
          - Windows 10/11 ì§€ì›
          
          ### ðŸŽ macOS  
          - `.dmg` íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì„¤ì¹˜
          - macOS 10.13+ ì§€ì›
          - Intel & Apple Silicon í˜¸í™˜
          
          ## ðŸ”§ ì„¤ì¹˜ ë°©ë²•
          
          **Windows:**
          1. `.msi` íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          2. íŒŒì¼ ì‹¤í–‰í•˜ì—¬ ì„¤ì¹˜
          
          **macOS:**
          1. `.dmg` íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          2. DMG ë§ˆìš´íŠ¸ í›„ ì•±ì„ Applications í´ë”ë¡œ ë“œëž˜ê·¸
          
          ---
          
          ðŸ’¡ **ë¬¸ì œ ë°œìƒ ì‹œ:** [GitHub Issues](https://github.com/${{ github.repository }}/issues)ì—ì„œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.
        files: |
          artifacts/windows-msi/*
          artifacts/macos-dmg/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“‹ Next Steps
      if: always()
      run: |
        echo "## ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. ðŸ“¥ **Download artifacts** from the build summary above" >> $GITHUB_STEP_SUMMARY
        echo "2. ðŸ§ª **Test applications** on respective platforms" >> $GITHUB_STEP_SUMMARY
        echo "3. ðŸš€ **Create release** from main branch to publish" >> $GITHUB_STEP_SUMMARY
        echo "4. ðŸ“¢ **Share with users** for feedback" >> $GITHUB_STEP_SUMMARY
